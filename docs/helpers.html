<!DOCTYPE html>

<html>
<head>
  <title>helpers.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="auth.html">
                auth.js
              </a>
            
              
              <a class="source" href="bid.html">
                bid.js
              </a>
            
              
              <a class="source" href="mybids.html">
                mybids.js
              </a>
            
              
              <a class="source" href="mystore.html">
                mystore.js
              </a>
            
              
              <a class="source" href="products.html">
                products.js
              </a>
            
              
              <a class="source" href="profile.html">
                profile.js
              </a>
            
              
              <a class="source" href="canvas-to-blob.html">
                canvas-to-blob.js
              </a>
            
              
              <a class="source" href="sell.html">
                sell.js
              </a>
            
              
              <a class="source" href="services.html">
                services.js
              </a>
            
              
              <a class="source" href="bidController.html">
                bidController.js
              </a>
            
              
              <a class="source" href="bidRoutes.html">
                bidRoutes.js
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.js
              </a>
            
              
              <a class="source" href="middleware.html">
                middleware.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="clear_db.html">
                clear_db.js
              </a>
            
              
              <a class="source" href="db_config.html">
                db_config.js
              </a>
            
              
              <a class="source" href="dummy_data.html">
                dummy_data.js
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.js
              </a>
            
              
              <a class="source" href="productController.html">
                productController.js
              </a>
            
              
              <a class="source" href="productRoutes.html">
                productRoutes.js
              </a>
            
              
              <a class="source" href="server.html">
                server.js
              </a>
            
              
              <a class="source" href="userController.html">
                userController.js
              </a>
            
              
              <a class="source" href="userRoutes.html">
                userRoutes.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>helpers.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../server/db/db_config.js'</span>);
<span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>);
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>create a  user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> createUser = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) </span>{
  db.User.create(user)
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{
    <span class="hljs-keyword">return</span> result;
  })
  .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error creating new user:'</span>, error);
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>User format is Object, Product format is Object, Tags format is Array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> createProduct = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">userModel, product, tags, callback</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>FindOne with user.email
findOrCreate tags
Create product</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Allows for </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> productModel;

  <span class="hljs-keyword">var</span> promiseModels = [];
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; tags.length; i++) {
    promiseModels.push(db.Tag.findOrCreate({where: { tagName: tags[i] }}));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>promiseModels.push(db.User.findOne({where: {email: user.email}}));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  promiseModels.push(db.Product.create(product));

  <span class="hljs-built_in">Promise</span>.all(promiseModels)
  .spread(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
    productModel = args.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>userModel = args.pop();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> results = [];
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {
      results.push(args[i][<span class="hljs-number">0</span>]);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Save</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> productModel.setTags(results);
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">results</span>) </span>{
    <span class="hljs-keyword">return</span> productModel.setUser(userModel);
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Success! Create a product with user and tags.'</span>);
    callback(<span class="hljs-literal">null</span>, result);
  })
  .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error in createProduct function: '</span>, error);
    callback(error, <span class="hljs-literal">null</span>);
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>accepts location input from the user and makes a call to the google maps api
to get the longitude and latitude</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> addLongAndLat = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) </span>{
  <span class="hljs-keyword">if</span> (!process.env.GoogleKey) {
    <span class="hljs-keyword">var</span> locally = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../sneakyLocal.js'</span>);
  }

  <span class="hljs-keyword">var</span> inputs = [];
  <span class="hljs-keyword">var</span> address = [];

  <span class="hljs-keyword">if</span> (user.address1) { inputs.push(user.address1)      ;}
  <span class="hljs-keyword">if</span> (user.address2) { inputs.push(user.address2)      ;}
  <span class="hljs-keyword">if</span> (user.city)     { inputs.push(user.city)          ;}
  <span class="hljs-keyword">if</span> (user.state)    { inputs.push(user.state)         ;}
  <span class="hljs-keyword">if</span> (user.zip)      { inputs.push(user.zip.toString());}
  <span class="hljs-keyword">if</span> (user.country)  { inputs.push(user.country)       ;}

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; inputs.length; i++) {
    address.push(inputs[i].split(<span class="hljs-string">' '</span>).join(<span class="hljs-string">'+'</span>));
  }

  address = address.join(<span class="hljs-string">',+'</span>);

  <span class="hljs-keyword">var</span> url = <span class="hljs-string">'https://maps.googleapis.com/maps/api/geocode/json?address='</span> + address + <span class="hljs-string">'&amp;key='</span> + (process.env.GoogleKey || locally.GoogleKey);
  <span class="hljs-keyword">return</span> request(url, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, response, body</span>) </span>{
    <span class="hljs-keyword">if</span> (!error &amp;&amp; response.statusCode === <span class="hljs-number">200</span>) {
      <span class="hljs-keyword">var</span> JSONbody = <span class="hljs-built_in">JSON</span>.parse(body);
      <span class="hljs-keyword">var</span> longitude = JSONbody.results[<span class="hljs-number">0</span>].geometry.location.lng;
      <span class="hljs-keyword">var</span> latitude = JSONbody.results[<span class="hljs-number">0</span>].geometry.location.lat;
      <span class="hljs-keyword">return</span> db.User.update({ 
        longitude: longitude,
        latitude: latitude,
      }, {
        where: {
          email: user.email
        }
      });
    }
  });
};

exports.createProduct = createProduct;
exports.addLongAndLat = addLongAndLat;



<span class="hljs-keyword">var</span> storeBid = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">bidAmount, product, bidder, callback</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>find</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    db.Bid.find({where: {
      ProductId: product.id,
      UserId: bidder.id
    }})
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">bid</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>if found - update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(bid) {
        bid.updateAttributes({
          bidAmount: bidAmount
        })
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">success</span>) </span>{
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'We just updated a bid!'</span>)
          callback(<span class="hljs-literal">null</span>, success);
        })
        .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'We had an error in storeBid &gt; helper.js - updating a bid.'</span>);
          callback(error, <span class="hljs-literal">null</span>);
        })

      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(bid === <span class="hljs-literal">null</span>) {
        db.Bid.create({
          bidAmount: bidAmount,
          UserId: bidder.id,
          ProductId: product.id
        })
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">success</span>) </span>{
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'We just created a new bid!'</span>)
          callback(<span class="hljs-literal">null</span>, success);
        })
        .catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'We had an error in storeBid &gt; helper.js - creating a new bid.'</span>)
          callback(<span class="hljs-literal">null</span>, success);
        })
      }

    }) 
    .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'We had an error in storeBid &gt; helper.js - finding the Bid.'</span>);
      callback(error, <span class="hljs-literal">null</span>);
    })
  }

exports.createProduct = createProduct;
exports.storeBid = storeBid;

<span class="hljs-keyword">var</span> maxProductId = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">array</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>library object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> library = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>output array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> outArray = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>max count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> maxCount = <span class="hljs-number">1</span>;
  _.each(array, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>if doesnâ€™t exist in library, insert into library</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!library.hasOwnProperty(object.dataValues.ProductId)) {
      library[object.dataValues.ProductId] = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span>(maxCount === <span class="hljs-number">1</span>) {
        outArray.push(object.dataValues.ProductId);
      }
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// if it does exist in library, then increment the count</span>
      library[object.dataValues.ProductId]++;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>If that count is greater than the max</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(library[object.dataValues.ProductId] &gt; maxCount) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>clear the outArray</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        outArray = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>increment max count, insert into output array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        maxCount++;
        outArray.push(object.dataValues.ProductId);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(library[object.dataValues.ProductId] === maxCount) {
        outArray.push(object.dataValues.ProductId);
      }
    }
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Library"</span>, library);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"outArray"</span>, outArray);
  });

  <span class="hljs-keyword">return</span> outArray;
};

exports.maxProductId = maxProductId;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
